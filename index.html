<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Carte des logements</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
        }
        #map {
            height: 100vh;
            width: 100vw;
        }
    </style>
</head>
<body>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
// -------------------------
// Initialisation de la carte
// -------------------------
let map = L.map('map').setView([48.43, -71.06], 13); // Saguenay

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 20
}).addTo(map);

// Flag pour ne charger les logements qu'une seule fois
let logementsCharges = false;

// -------------------------
// Injection progressive des logements
// -------------------------
map.on("zoomend", () => {
    const z = map.getZoom();
    if (z >= 15 && !logementsCharges) {
        logementsCharges = true;
        chargerLogements();
    }
});

function chargerLogements() {
    fetch("https://registre-logements-demo.onrender.com/logements")
        .then(r => r.json())
        .then(data => {
            data.forEach(log => {
                if (log.lat && log.lon) {
                    L.marker([log.lat, log.lon])
                        .addTo(map)
                        .bindPopup(`
                            <strong>${log.adresse_complete}</strong><br>
                            ${log.ville}<br>
                            Type : ${log.type_logement || "N/A"}<br>
                            Chambres : ${log.nombre_chambres || "N/A"}
                        `);
                }
            });
        })
        .catch(err => {
            console.error("Erreur chargement logements:", err);
        });
}

// -------------------------
// Tracer le contour d'un bâtiment via Overpass
// -------------------------
function tracerBatiment(lat, lon) {
    const query = `
        [out:json][timeout:10];
        way["building"](around:20,${lat},${lon});
        out geom;
    `;

    fetch("https://overpass-api.de/api/interpreter", {
        method: "POST",
        body: query
    })
    .then(r => r.json())
    .then(data => {
        if (!data.elements || data.elements.length === 0) {
            console.log("Aucun bâtiment trouvé autour de ce point.");
            return;
        }

        // On prend le premier bâtiment trouvé
        const bat = data.elements[0];
        const coords = bat.geometry.map(p => [p.lat, p.lon]);

        const poly = L.polygon(coords, {
            color: "red",
            weight: 3,
            fillOpacity: 0.3
        }).addTo(map);

        // Centrer la carte sur le bâtiment
        map.fitBounds(poly.getBounds());
    })
    .catch(err => {
        console.error("Erreur Overpass:", err);
    });
}

// -------------------------
// Appel spécifique : 725 Rue Jolliet, Saguenay
// -------------------------
// Coordonnées approximatives du 725 Rue Jolliet, Saguenay
const LAT_JOLLIET_725 = 48.42812;
const LON_JOLLIET_725 = -71.06891;

// On trace le bâtiment dès le chargement
tracerBatiment(LAT_JOLLIET_725, LON_JOLLIET_725);

</script>

</body>
</html>
